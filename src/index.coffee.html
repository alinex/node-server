<!DOCTYPE html>
<html>
<head>
  <title>index.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "home/alex/a3/node-server/src/index.coffee", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
  <script src="../fileSearch.js"></script>
  <script src="../goToLine.js"></script>
  <link rel="stylesheet" href="../fileSearch.css" />
  <link rel="stylesheet" href="../goToLine.css" />
</head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io" onmouseover="lllogo.src='https://alinex.github.io/images/Alinex-200.png'" onmouseout="lllogo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="lllogo" src="https://alinex.github.io/images/Alinex-black-200.png" width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png" style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog.html" class="btn btn-primary"><span class="glyphicon-cog"></span> Blog</a>
  <a href="http://alinex.github.io/code.html" class="btn btn-warning"><span class="glyphicon-pencil"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#startup%20alinex%20server">Startup Alinex Server</a>
      </div>
      <div class="heading h2">
        <a href="#node%20modules">Node Modules</a>
      </div>
      <div class="heading h2">
        <a href="#forked%20server%20node">Forked server node</a>
      </div>
      <div class="heading h2">
        <a href="#server%20class">Server class</a>
      </div>
      <div class="heading h3">
        <a href="#create%20instance">Create instance</a>
      </div>
      <div class="heading h3">
        <a href="#start%20the%20server">Start the server</a>
      </div>
      <div class="heading h3">
        <a href="#start%20the%20server">Start the server</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-server" title="Fork me on GitHub"></a><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
<div class="pilwrap" id="startup%20alinex%20server">
  <h1>
    <a href="#startup%20alinex%20server" name="startup%20alinex%20server" class="pilcrow">&#182;</a>
    Startup Alinex Server
  </h1>
</div>


<p>This file is used to start the whole system. It will start as single server
or cluster server depending on the <code>NODE_ENV</code> setting.</p>

<p>For productive system the server starts as cluster to use the power of
multi core architectures. It is not aimed for multi server cluster, this have
to be set up on top.</p>

<p>To configure the system use the <code>config/server.coffee</code> file.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="node%20modules">
  <h2>
    <a href="#node%20modules" name="node%20modules" class="pilcrow">&#182;</a>
    Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>include base modules</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">debug = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">)(</span><span class="s">&#39;server&#39;</span><span class="p">)</span>
<span class="nv">EventEmitter = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span>
<span class="nv">cluster = </span><span class="nx">require</span> <span class="s">&#39;cluster&#39;</span>
<span class="nv">express = </span><span class="nx">require</span> <span class="s">&#39;express&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>alinex modules</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">Config = </span><span class="nx">require</span> <span class="s">&#39;alinex-config&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>internal helpers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">configcheck = </span><span class="nx">require</span> <span class="s">&#39;./configcheck&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="forked%20server%20node">
  <h2>
    <a href="#forked%20server%20node" name="forked%20server%20node" class="pilcrow">&#182;</a>
    Forked server node
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">unless</span> <span class="nx">cluster</span><span class="p">.</span><span class="nx">isMaster</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>start server</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;sorry, cluster support not implemented!&quot;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="server%20class">
  <h2>
    <a href="#server%20class" name="server%20class" class="pilcrow">&#182;</a>
    Server class
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">class</span> <span class="nx">Server</span> <span class="k">extends</span> <span class="nx">EventEmitter</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="create%20instance">
  <h3>
    <a href="#create%20instance" name="create%20instance" class="pilcrow">&#182;</a>
    Create instance
  </h3>
</div>


<p>This will only store the reference to the configuration object. This may be
an <a href="http://alinex.github.io/node-config">alinex-config</a>, a name for the
configuration to load or the configuration structure itself.
The configuration loading will start, after finished an <code>init</code> event is
thrown and the <code>init</code> flag is set.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">constructor: </span><span class="nf">(@config = &#39;server&#39;, app) -&gt;</span>
    <span class="nx">debug</span> <span class="s">&quot;create new server instance&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>set config from different values</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">@config</span> <span class="o">is</span> <span class="s">&#39;string&#39;</span>
      <span class="vi">@config = </span><span class="nx">Config</span><span class="p">.</span><span class="nx">instance</span> <span class="nx">@config</span>
      <span class="nx">@config</span><span class="p">.</span><span class="nx">setCheck</span> <span class="nx">configcheck</span>
    <span class="k">if</span> <span class="nx">@config</span> <span class="k">instanceof</span> <span class="nx">Config</span>
      <span class="vi">@configClass = </span><span class="nx">@config</span>
      <span class="vi">@config = </span><span class="nx">@configClass</span><span class="p">.</span><span class="nx">data</span>
      <span class="vi">@name = </span><span class="nx">@configClass</span><span class="p">.</span><span class="nx">name</span>
    <span class="vi">@initDone = </span><span class="kc">false</span> <span class="c1"># status set to true after initializing</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>set init status if configuration is loaded</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">unless</span> <span class="nx">@configClass</span><span class="o">?</span>
      <span class="nx">@_init</span> <span class="nx">app</span>
    <span class="k">else</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>wait till configuration is loaded</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@configClass</span><span class="p">.</span><span class="nx">load</span> <span class="nf">(err) =&gt;</span>
        <span class="nx">@emit</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">@_init</span> <span class="nx">app</span>

  <span class="nv">_init: </span><span class="nf">(app) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>setup app</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="vi">@app = </span><span class="nx">express</span><span class="p">()</span>
    <span class="nx">@app</span><span class="p">.</span><span class="nx">disable</span> <span class="s">&#39;x-powered-by&#39;</span>
    <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">trustProxy</span>
      <span class="nx">@app</span><span class="p">.</span><span class="nx">enable</span> <span class="s">&#39;trust proxy&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>ip restriction</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">restrictIP</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">restrictIP</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">ips = </span><span class="k">new</span> <span class="nb">RegExp</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">restrictIP</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;|&#39;</span>
      <span class="nx">@app</span><span class="p">.</span><span class="nx">all</span> <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="nf">(req, res, next) -&gt;</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ip</span><span class="p">.</span><span class="nx">match</span> <span class="nx">ips</span>
          <span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&#39;The IP %s is not allowed.&#39;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">ip</span>
          <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Your IP (</span><span class="si">#{</span><span class="nx">req</span><span class="p">.</span><span class="nx">ip</span><span class="si">}</span><span class="s">) is not allowed.&quot;</span>
          <span class="nv">err.status = </span><span class="mi">403</span>
          <span class="k">return</span> <span class="nx">next</span> <span class="nx">err</span>
        <span class="nx">next</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>use given rules</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@app</span><span class="p">.</span><span class="nx">use</span> <span class="nx">app</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>default homepage</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@app</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="nf">(req, res) -&gt;</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="s">&#39;Alinex Server running!&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>file not found error</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@app</span><span class="p">.</span><span class="nx">use</span> <span class="nf">(req, res, next) -&gt;</span>
      <span class="nv">err = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Resource not found!&quot;</span>
      <span class="nv">err.status = </span><span class="mi">404</span>
      <span class="nx">next</span> <span class="nx">err</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>handling errors</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@app</span><span class="p">.</span><span class="nx">use</span> <span class="nf">(err, req, res, next) -&gt;</span>
      <span class="nx">err</span><span class="p">.</span><span class="nx">status</span> <span class="o">?=</span> <span class="mi">500</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">status</span> <span class="nx">err</span><span class="p">.</span><span class="nx">status</span>
      <span class="nx">res</span><span class="p">.</span><span class="nx">send</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>initialization done</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="vi">@initDone = </span><span class="kc">true</span>
    <span class="nx">@emit</span> <span class="s">&#39;init&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="start%20the%20server">
  <h3>
    <a href="#start%20the%20server" name="start%20the%20server" class="pilcrow">&#182;</a>
    Start the server
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">start: </span><span class="nf">(cb, loaded = false) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>wait till configuration is loaded</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">unless</span> <span class="nx">@initDone</span> <span class="o">and</span> <span class="nx">loaded</span>
      <span class="k">return</span> <span class="nx">@once</span> <span class="s">&#39;init&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@start</span> <span class="nx">cb</span><span class="p">,</span> <span class="kc">true</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>support callback through event wrapper</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="nx">cb</span>
      <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
        <span class="nx">debug</span> <span class="s">&quot;Error: </span><span class="si">#{</span><span class="nx">err</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">cb</span> <span class="nx">err</span>
        <span class="nv">cb = </span><span class="nf">-&gt;</span>
      <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;start&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>
        <span class="nv">config = </span><span class="nx">@config</span><span class="p">.</span><span class="nx">data</span>
        <span class="nx">debug</span> <span class="s">&quot;listening on http://localhost:</span><span class="si">#{</span><span class="nx">@config</span><span class="p">.</span><span class="nx">port</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">cb</span><span class="p">()</span>
        <span class="nv">cb = </span><span class="nf">-&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>start the server</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">debug</span> <span class="s">&quot;start server </span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">@config</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>start the server</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="vi">@server = </span><span class="nx">@app</span><span class="p">.</span><span class="nx">listen</span> <span class="nx">@config</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="nf">(err) =&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">code</span> <span class="o">is</span> <span class="s">&#39;EADDRINUSE&#39;</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">bold</span><span class="p">.</span><span class="nx">red</span> <span class="s">&#39;Failed to bind to port - address already in use &#39;</span>
          <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span> <span class="mi">1</span>
        <span class="k">else</span>
          <span class="nx">@emit</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span>
      <span class="k">else</span>
        <span class="nx">@emit</span> <span class="s">&#39;start&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="start%20the%20server">
  <h3>
    <a href="#start%20the%20server" name="start%20the%20server" class="pilcrow">&#182;</a>
    Start the server
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">stop: </span><span class="nf">(cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>support callback through event wrapper</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="nx">cb</span>
      <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(err) -&gt;</span>
        <span class="nx">debug</span> <span class="s">&quot;Error: </span><span class="si">#{</span><span class="nx">err</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nx">cb</span> <span class="nx">err</span>
        <span class="nv">cb = </span><span class="nf">-&gt;</span>
      <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;stop&#39;</span><span class="p">,</span> <span class="nf">-&gt;</span>
        <span class="nx">debug</span> <span class="s">&quot;server stopped&quot;</span>
        <span class="nx">cb</span><span class="p">()</span>
        <span class="nv">cb = </span><span class="nf">-&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>stop server</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@server</span><span class="p">.</span><span class="nx">close</span> <span class="nf">(err) =&gt;</span>
      <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">@emit</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nx">err</span>
      <span class="k">else</span>
        <span class="nx">@emit</span> <span class="s">&#39;stop&#39;</span>

<span class="nv">module.exports = </span><span class="nx">Server</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
